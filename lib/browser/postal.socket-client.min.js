(function(a,b,c){typeof define=="function"&&define.amd?define(["underscore","machina","postal"],function(d,e,f){return c(d,e,f,a,b)}):c(a._,a.machina,a.postal,a,b)})(this,document,function(a,b,c,d,e,f){c.configuration.getSessionIdentifier=function(a){a(f)},c.configuration.lastSessionId=null,c.getSubscribersFor=function(){var a=arguments[0],b=arguments[1],d=[];return arguments.length===1&&(Object.prototype.toString.call(a)==="[object String]"?(a=c.configuration.DEFAULT_CHANNEL,b=arguments[0]):(a=arguments[0].channel||c.configuration.DEFAULT_CHANNEL,b=arguments[0].topic)),c.configuration.bus.subscriptions[a]&&c.configuration.bus.subscriptions[a].hasOwnProperty(b)&&(d=c.configuration.bus.subscriptions[a][b]),d},c.connections=c.connections||{};var g=c.connections.socket=function(){var d,e=new b.Fsm({retryFn:f,wireUpSocketEvents:function(){var b=this;a.each(["connect","connecting","connect_failed","disconnect","reconnect","reconnect_failed","reconnecting","postal.socket.remote","postal.socket.identified","postal.socket.migration"],function(a){d.on(a,function(c){b.handle(a,c)})})},states:{uninitialized:{tryConnect:function(){this.transition("initializing")}},initializing:{_onEnter:function(){d=io.connect(g.config.url,{"auto connect":!1}),this.wireUpSocketEvents(),this.transition("probing")},socketTransmit:function(){this.deferUntilTransition("online")}},probing:{_onEnter:function(){clearTimeout(this.retryFn),!d.socket.connecting&&!d.socket.reconnecting&&d.socket.connect()},connect:function(){this.transition("identifying")},connect_failed:function(){this.transition("disconnected")},maxAttempts:function(){this.transition("offline")},"postal.socket.remote":function(){this.deferUntilTransition("online")},reconnect:function(){this.transition("identifying")},reconnect_failed:function(){this.transition("disconnected")},socketTransmit:function(){this.deferUntilTransition("online")}},identifying:{_onEnter:function(){var a=this;a.retryFn=setTimeout(function(){a.handle("timeout.identifying")},g.config.reconnectInterval),c.configuration.getSessionIdentifier(function(b){a.handle("client.identifier",{sessionId:b||d.socket.sessionid})})},"client.identifier":function(a){clearTimeout(this.retryFn);var b=c.configuration.lastSessionId;c.configuration.lastSessionId=a.sessionId,d.emit("postal.clientId",{sessionId:c.configuration.lastSessionId,lastSessionId:b})},connect_failed:function(){this.transition("disconnected")},disconnect:function(){this.transition("probing")},"postal.socket.identified":function(a){this.transition("online")},"postal.socket.migration":function(){a.each(c.socket.manifest,function(a){e.handle("socketTransmit","postal.subscribe",a)}),d.emit("postal.migrationComplete",{})},"postal.socket.remote":function(){this.deferUntilTransition("online")},reconnect_failed:function(){this.transition("disconnected")},socketTransmit:function(b,e){if(b==="postal.subscribe"){var f=a.extend({},e);f.correlationId=c.configuration.lastSessionId,d.emit(b,f)}else this.deferUntilTransition("online")},"timeout.identifying":function(){this.transition("probing")}},online:{disconnect:function(){this.transition("probing")},goOffline:function(){this.transition("offline")},"postal.socket.remote":function(a){c.publish(a)},socketTransmit:function(b,e){var f=a.extend({},e);f.correlationId=c.configuration.lastSessionId,d.emit(b,f)}},offline:{_onEnter:function(){d.socket.disconnect()},socketTransmit:function(){this.deferUntilTransition("online")},tryConnect:function(){this.transition("probing")}},disconnected:{_onEnter:function(){var a=this;a.retryFn=setTimeout(function(){a.transition("probing")},g.config.reconnectInterval)},connecting:function(){this.transition("probing")},reconnecting:function(){this.transition("probing")},socketTransmit:function(){this.deferUntilTransition("online")}}}});return{config:{url:window.location.origin,reconnectInterval:4e3},goOffline:function(){e.handle("goOffline")},goOnline:function(){e.handle("tryConnect")},manifest:[],publish:function(a){e.handle("socketTransmit","postal.publish",a)},subscribe:function(b){b.channel=b.channel||c.configuration.DEFAULT_CHANNEL,b.topic=b.topic||"*",a.any(this.manifest,function(a){return a.channel===b.channel&&a.topic===b.topic})||(this.manifest.push(b),e.handle("socketTransmit","postal.subscribe",b))},socketMgr:e,socketNamespace:d,unsubscribe:function(a){a.channel=a.channel||c.configuration.DEFAULT_CHANNEL,a.topic=a.topic||"*",c.getSubscribersFor(a.channel,a.topic).length||e.handle("socketTransmit","postal.unsubscribe",a)}}}();c.connections.socket.goOnline();var h=c.channelTypes.websocket=function(a,b){var d=c.channel(a,b),e=d.subscribe,f=d.publish,i=d.topic;return d.publish=function(){g.publish(f.apply(d,arguments))},d.subscribe=function(){var a=e.apply(d,arguments),b;return b=a.unsubscribe,a.unsubscribe=function(){b.call(a),g.unsubscribe({channel:a.channel,topic:a.topic})},g.subscribe({channel:a.channel,topic:a.topic}),a},d.topic=function(a){return a===d._topic?this:new h(this.channel,a)},d}})